<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://dagrejs.github.io/project/dagre/v0.7.5/dagre.min.js"></script>
<script src="https://dagrejs.github.io/project/graphlib-dot/v0.6.3/graphlib-dot.min.js"></script>
<script src="https://dagrejs.github.io/project/dagre-d3/latest/dagre-d3.min.js"></script>

<style>
    .node {
        white-space: nowrap;
    }

    .node rect,
    .node circle,
    .node ellipse {
        stroke: #333;
        fill: #fff;
        stroke-width: 1.5px;
    }

    .cluster rect {
        stroke: #333;
        fill: #000;
        fill-opacity: 0.1;
        stroke-width: 1.5px;
    }

    .edgePath path.path {
        stroke: #333;
        stroke-width: 1.5px;
        fill: none;
    }
</style>

<svg id="svg-id" height="450" width="800" style="margin: auto; display: block">
    <g/>
</svg>
<script>

    // {
    //     projectName: string;
    //     edgesTo: string[];
    //     responsibles: string[];
    //     affectedFiles: string[];
    //     isAffected: boolean
    // }

    const dagreGraph = new dagreD3.graphlib.Graph().setGraph({});
    // graphData corresponds to IYaniceGraphNodeInfo[] (see graph-dagre-renderer.ts)
    const graphData = JSON.parse('INSERT-GRAPH-DATA-STRINGIFIED-HERE');

    function getNodeStyle(data) {
        var styleStr = "stroke-width: 2px;";
        if(!data.hasCommandForScope) {
            styleStr = styleStr.concat("stroke-dasharray: 5, 5;");
        }
        if(data.isAffected) {
            styleStr = styleStr.concat("fill: #d0172791;")
        }
        return styleStr.length > 0 ? {style: styleStr} : {};
    }

    graphData.forEach(data => {
        dagreGraph.setNode(data.projectName, getNodeStyle(data));
        data.edgesTo.forEach(e => dagreGraph.setEdge(data.projectName, e, {curve: d3.curveBasis}));
    });


    const svg = d3.select("svg"),
        inner = d3.select("svg g"),
        zoom = d3.zoom().on("zoom", function() {
            inner.attr("transform", d3.event.transform);
        });
    svg.call(zoom);

    if (!dagreGraph.graph().hasOwnProperty("marginx") &&
        !dagreGraph.graph().hasOwnProperty("marginy")) {
        dagreGraph.graph().marginx = 20;
        dagreGraph.graph().marginy = 20;
    }

    dagreGraph.graph().transition = function(selection) {
        return selection.transition().duration(500);
    };

    dagre.layout(dagreGraph);

    const render = dagreD3.render();
    render(d3.select("svg g"), dagreGraph);

    const svgHeight = dagreGraph.graph().height;
    const svgWidth = dagreGraph.graph().width;
    document.getElementById('svg-id').setAttribute("height", svgHeight * 1.2);
    document.getElementById('svg-id').setAttribute("width", svgWidth * 1.2);
</script>
